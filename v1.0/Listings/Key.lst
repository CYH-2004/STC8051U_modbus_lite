C251 COMPILER V5.60.0,  Key                                                                11/01/26  10:39:44  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE Key
OBJECT MODULE PLACED IN .\Objects\Key.obj
COMPILER INVOKED BY: D:\Software_D\Keil_v5\C251\BIN\C251.EXE Basic\Key.c XSMALL INTR2 BROWSE INCDIR(.\User;.\Modbus_lite
                    -;.\Library;.\Basic;.\SSD1306) DEBUG PRINT(.\Listings\Key.lst) TABS(2) OBJECT(.\Objects\Key.obj) 

stmt  level    source

    1          
    2          #include "Key.h"
    3          
    4          //处理按键程序*************************************************************************************
    5          //仅检测单键，会等待按键松开
    6          void key_scan(void)           //按键处理
    7          {
    8   1        uchar i;
    9   1        //P2=0Xff;
   10   1        KEY_OK=1;
   11   1      key_in:
   12   1        n_ms(10);
   13   1        //i=P2;
   14   1        //i=i&0x01;         //P3.5为按键输入;ok=0x01,down=0x02,up=0x04
   15   1        i=KEY_OK;
   16   1        if(i>0) 
   17   1        goto key_in;
   18   1      key_hold:
   19   1        n_ms(10);
   20   1          //i=P2;
   21   1        //i=i&0x01;
   22   1        i=KEY_OK;
   23   1        if(i<1)
   24   1        goto key_hold;
   25   1      }
   26          
   27          //延时处理按键程序********************************************************************************
   28          //仅检测单键，等待时间有限
   29          void key_scan1(uint16_t dtime)            //dtime=5000>>>>time<=8s
   30          {
   31   1        uchar i;
   32   1        uint j;
   33   1        //P2=0Xff;
   34   1        KEY_OK=1;
   35   1        j=0;
   36   1      key_in:
   37   1        n_ms(10);
   38   1        //i=P2;           //P2.0=ok,P2.1=down,P2.2=up
   39   1        //i=i&0x01;         //P3.5为按键输入;ok=0x01,down=0x02,up=0x04
   40   1        i=KEY_OK;
   41   1        if(i>0)
   42   1        {
   43   2          if(j<dtime)
   44   2          {
   45   3            j++;
   46   3            goto key_in;
   47   3          }
   48   2        }
   49   1      key_hold:
   50   1        n_ms(10);
   51   1          //i=P2;
   52   1        //i=i&0x01;
   53   1        i=KEY_OK;
   54   1        if(i<1)
   55   1        {
   56   2          if(j<dtime)
   57   2          {
   58   3            j++;
C251 COMPILER V5.60.0,  Key                                                                11/01/26  10:39:44  PAGE 2   

   59   3            goto key_hold;
   60   3          }
   61   2        }
   62   1      }
   63          
   64          //延时检测按键程序********************************************************************************
   65          //编写于2024年寒假，当时不知道IO口可以位操作，结果就照着之前的按键检测用字节操作了
   66          //多键检测
   67          //修改于2024年6月19日，暂未验证，如果出问题可以回旧版本复制回来
   68          uint8_t key_scan2(uint16_t dtime)
   69          {
   70   1        uchar i,pin_address;
   71   1        uint j;
   72   1        j=0;
   73   1        pin_address=0;//扫描结果初始化
   74   1        //P2=0Xff;//端口初始化
   75   1        KEY_OK=1;
   76   1        KEY_UP=1;
   77   1        KEY_DOWN=1;
   78   1      
   79   1      scan_start://端口扫描，在任意按键被按下前重复检测，直到延时结束
   80   1        n_ms(10);
   81   1      
   82   1        //P1=0x0c;//尝试用P1控制LED
   83   1        if(j>dtime)
   84   1        {
   85   2          goto scan_finish;
   86   2        } 
   87   1        //i=P2;
   88   1        //i=i&0x01;
   89   1        i=KEY_OK;
   90   1        if (i<1) 
   91   1          {
   92   2            pin_address=1;
   93   2            goto scan_check;
   94   2          }
   95   1        //i=P2;
   96   1        //i=i&0x02; 
   97   1        i=KEY_DOWN;
   98   1        if (i<1) 
   99   1          {
  100   2            pin_address=2;
  101   2            goto scan_check;
  102   2          }
  103   1        //i=P2;
  104   1        //i=i&0x04; 
  105   1        i=KEY_UP;
  106   1        if (i<1) 
  107   1          {
  108   2            pin_address=3;
  109   2            goto scan_check;
  110   2          }
  111   1        if (j<dtime) 
  112   1          {
  113   2            j++;
  114   2            goto scan_start;
  115   2          }
  116   1        goto scan_finish;
  117   1      scan_check://检测到按键按下后确认按键松开，直到延时结束
  118   1        switch (pin_address)
  119   1        {
  120   2          case 1:
  121   2            n_ms(10);
  122   2              //i=P2;
  123   2            //i=i&0x01;
  124   2            i=KEY_OK;
C251 COMPILER V5.60.0,  Key                                                                11/01/26  10:39:44  PAGE 3   

  125   2            if(i<1&&j<dtime)
  126   2            {
  127   3              j++;
  128   3              goto scan_check;
  129   3            }
  130   2            goto scan_start;
  131   2            break;
  132   2          case 2:
  133   2            n_ms(10);
  134   2              //i=P2;
  135   2            //i=i&0x02; 
  136   2            i=KEY_DOWN;
  137   2            if(i<1&&j<dtime)
  138   2            {
  139   3              j++;
  140   3              goto scan_check;
  141   3            }
  142   2            goto scan_start;
  143   2            break;
  144   2          case 3:
  145   2            n_ms(10);
  146   2              //i=P2;
  147   2            //i=i&0x04; 
  148   2            i=KEY_UP;
  149   2            if(i<1&&j<dtime)
  150   2            {
  151   3              j++;
  152   3              goto scan_check;
  153   3            }
  154   2            goto scan_start;
  155   2            break;
  156   2          default://无输入状态
  157   2            goto scan_start;//检测确认完成，再次进入检测按键按下
  158   2        }
  159   1      scan_finish://结束检测，返回检测结果
  160   1        P1=0x00;
  161   1        return pin_address;//无操作时为0，第0脚时为1，第1脚时为2，第2脚时为3
  162   1      }
  163          
  164          //按键检测与反应时间反馈*********************************************************************************
             -****
  165          uint16_t key_scan3(uint16_t dtime)            //dtime=5000>>>>time<=8s
  166          {
  167   1        uchar i;
  168   1        uint j;
  169   1        //P2=0Xff;
  170   1        KEY_OK=1;
  171   1        j=0;
  172   1      key_in:
  173   1        n_ms(10);
  174   1        //i=P2;           //P2.0=ok,P2.1=down,P2.2=up
  175   1        //i=i&0x01;         //P3.5为按键输入;ok=0x01,down=0x02,up=0x04
  176   1        i=KEY_OK;
  177   1        if(i>0)
  178   1        {
  179   2          if(j<dtime)
  180   2          {
  181   3            j++;
  182   3            goto key_in;
  183   3          }
  184   2        }
  185   1      key_hold:
  186   1        n_ms(10);
  187   1          //i=P2;
  188   1        //i=i&0x01;
  189   1        i=KEY_OK;
C251 COMPILER V5.60.0,  Key                                                                11/01/26  10:39:44  PAGE 4   

  190   1        if(i<1)
  191   1        {
  192   2          if(j<dtime)
  193   2          {
  194   3            j++;
  195   3            goto key_hold;
  196   3          }
  197   2        }
  198   1      return j%50;//返回范围缩限
  199   1      }
  200          
  201          
  202          
  203          //按键等待检测***********************************************************************
  204          //多键检测，不限时
  205          uint16_t key_scan4()
  206          {
  207   1        uchar i;
  208   1        uint j,pin_address;
  209   1        j=0;
  210   1        pin_address=0;//扫描结果初始化
  211   1        //P2=0Xff;//端口初始化
  212   1        KEY_OK=1;
  213   1        KEY_UP=1;
  214   1        KEY_DOWN=1;
  215   1      
  216   1      scan_start://端口扫描，在任意按键被按下前重复检测，直到延时结束
  217   1        n_ms(10);
  218   1        //P1=0x0c;//尝试用P1控制LED
  219   1      
  220   1        //i=P2;
  221   1        //i=i&0x01;
  222   1        i=KEY_OK;
  223   1        if (i<1) 
  224   1          {
  225   2            pin_address=1;
  226   2            goto scan_check;
  227   2          }
  228   1        //i=P2;
  229   1        //i=i&0x02; 
  230   1        i=KEY_DOWN;
  231   1        if (i<1) 
  232   1          {
  233   2            pin_address=2;
  234   2            goto scan_check;
  235   2          }
  236   1        //i=P2;
  237   1        //i=i&0x04; 
  238   1        i=KEY_UP;
  239   1        if (i<1) 
  240   1          {
  241   2            pin_address=3;
  242   2            goto scan_check;
  243   2          }
  244   1      
  245   1        j++;
  246   1        goto scan_start;
  247   1      scan_check://检测到按键按下后确认按键松开，直到延时结束
  248   1        switch (pin_address)
  249   1        {
  250   2          case 1:
  251   2            n_ms(10);
  252   2              //i=P2;
  253   2            //i=i&0x01;
  254   2            i=KEY_OK;
  255   2            if(i<1)
C251 COMPILER V5.60.0,  Key                                                                11/01/26  10:39:44  PAGE 5   

  256   2            {
  257   3              j++;
  258   3              goto scan_check;
  259   3            }
  260   2            goto scan_finish;
  261   2            break;
  262   2          case 2:
  263   2            n_ms(10);
  264   2              //i=P2;
  265   2            //i=i&0x02; 
  266   2            i=KEY_DOWN;
  267   2            if(i<1)
  268   2            {
  269   3              j++;
  270   3              goto scan_check;
  271   3            }
  272   2            goto scan_finish;
  273   2            break;
  274   2          case 3:
  275   2            n_ms(10);
  276   2              //i=P2;
  277   2            //i=i&0x04; 
  278   2            i=KEY_UP;
  279   2            if(i<1)
  280   2            {
  281   3              j++;
  282   3              goto scan_check;
  283   3            }
  284   2            goto scan_finish;
  285   2            break;
  286   2          default:
  287   2            goto scan_start;//检测确认完成，再次进入检测按键按下
  288   2        }
  289   1      scan_finish://结束检测，返回检测结果
  290   1        //P1=0x00;
  291   1        return pin_address;//无操作时为0，第0脚时为1，第1脚时为2，第2脚时为3
  292   1      }
  293          
  294          
  295          


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       645     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =    ------          5
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =    ------     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)

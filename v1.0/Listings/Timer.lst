C251 COMPILER V5.60.0,  Timer                                                              11/01/26  10:39:44  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE Timer
OBJECT MODULE PLACED IN .\Objects\Timer.obj
COMPILER INVOKED BY: D:\Software_D\Keil_v5\C251\BIN\C251.EXE Basic\Timer.c XSMALL INTR2 BROWSE INCDIR(.\User;.\Modbus_li
                    -te;.\Library;.\Basic;.\SSD1306) DEBUG PRINT(.\Listings\Timer.lst) TABS(2) OBJECT(.\Objects\Timer.obj) 

stmt  level    source

    1          #include "Timer.h"
    2          
    3          #include "Uart3.h"
    4          #include "Uart4.h"
    5          extern u8  TX3_number;
    6          
    7          uint32_t systick_count;
    8          
    9          void Delay1000ms(void);
   10          
   11          void n_ms(uint16_t x);
   12          // void delay_n_s(uint16_t x);//延时N-S子程序
   13          // void delay_n_100ms(uint16_t x);
   14          
   15          void n_ms_timer_0(void);
   16          
   17          void timer4_init(void);
   18          uint32_t get_systick(void);
   19          
   20          //软件延时
   21          // void Delay1000ms(void) //@44.2368MHz
   22          // {
   23          //  unsigned long edata i;
   24          
   25          //  _nop_();
   26          //  _nop_();
   27          //  i = 11059198UL;
   28          //  while (i) i--;
   29          // }
   30          
   31          void Delay1000ms(void)  //@40MHz
   32          {
   33   1        unsigned long edata i;
   34   1      
   35   1        _nop_();
   36   1        _nop_();
   37   1        i = 9999998UL;
   38   1        while (i) i--;
   39   1      }
   40          
   41          //延时N-MS子程序********************************************************************
   42          void n_ms(uint16_t x)
   43          {
   44   1        uint16_t i;
   45   1          for(i=0;i<x;i++)
   46   1          {
   47   2          n_ms_timer_0();
   48   2          }
   49   1      }
   50          
   51          
   52          //延时N-S子程序********************************************************************
   53          // void delay_n_s(uint16_t x)
   54          // {
   55          //     uint16_t i;
   56          //     uint16_t y;
   57          //     for(y=0;y<x;y++)
   58          //     {
C251 COMPILER V5.60.0,  Timer                                                              11/01/26  10:39:44  PAGE 2   

   59          //         for(i=0;i<1000;i++);
   60          //    n_ms_timer_0();
   61          //     }
   62          // }
   63          
   64          //延时N-100ms子程序********************************************************************
   65          // void delay_n_100ms(uint16_t x)
   66          // {
   67          //     uint16_t i;
   68          //     uint16_t y;
   69          //     for(y=0;y<x;y++)
   70          //     {
   71          //         for(i=0;i<100;i++)
   72          //    {
   73          //      n_ms_timer_0();
   74          //    }
   75          //     }
   76          // }
   77          
   78          //定时器0的阻塞式1ms延时***********************************************************
   79          void n_ms_timer_0(void)
   80          {  
   81   1          TMOD &= 0xF0; // 清除定时器0的控制位  
   82   1          TMOD |= 0x01; // 设置定时器0为模式1（16位定时器/计数器模式）  
   83   1        
   84   1          TL0 = T0MS & 0x00ff;            //reload timer1 low byte
   85   1          TH0 = T0MS >> 8;                //reload timer1 high byte
   86   1      
   87   1          TR0 = 1; // 启动定时器0  
   88   1        
   89   1          while(!TF0); // 等待定时器溢出
   90   1          
   91   1        
   92   1          TF0 = 0; // 清除溢出标志  
   93   1          TR0 = 0; // 停止定时器0  
   94   1      }
   95          
   96          
   97          // 配置使用T4作为systick生成器，时钟源选择系统时钟
   98          // 当前配置为每1ms产生一次中断
   99          
  100          void timer4_init(void)
  101          {
  102   1          systick_count = 0;
  103   1          
  104   1          // T4做定时器，1T模式，关闭时钟输出；关闭T3
  105   1          T4T3M = 0x20;
  106   1      
  107   1          // 设定时钟分频
  108   1          TM4PS = 39;
  109   1          
  110   1          // 定时器预设
  111   1          T4L = T4Tick_SET ;
  112   1          T4H = T4Tick_SET >>8;
  113   1          
  114   1          //定时器4开始计数，允许中断
  115   1          IE2 |= 0x40;
  116   1          T4T3M |= 0x80;
  117   1      }
  118          
  119          //T4中断服务程序
  120          void TM4_Isr() interrupt 20
  121          {
  122   1          systick_count++;
  123   1      
  124   1          //检查UART3接收缓冲区
C251 COMPILER V5.60.0,  Timer                                                              11/01/26  10:39:44  PAGE 3   

  125   1          if(RX3_TimeOut != 0)
  126   1        {
  127   2          if(--RX3_TimeOut == 0)  //超时
  128   2          {
  129   3            if(RX3_Cnt != 0)  //接收有数据
  130   3            {
  131   4              B_RX3_OK = 1; //标志已收到数据块
  132   4            }
  133   3          }
  134   2        }
  135   1          //检查UART4接收缓冲区
  136   1          if(RX4_TimeOut != 0)
  137   1        {
  138   2          if(--RX4_TimeOut == 0)  //超时
  139   2          {
  140   3            if(RX4_Cnt != 0)  //接收有数据
  141   3            {
  142   4              B_RX4_OK = 1; //标志已收到数据块
  143   4            }
  144   3          }
  145   2        }
  146   1      }
  147          
  148          //获取systick值
  149          uint32_t get_systick(void) 
  150          {
  151   1          // return T11CR;
  152   1          return systick_count;
  153   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       165     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =         4     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =    ------     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
